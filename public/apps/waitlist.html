<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Waitlist - Referral System</title>
  <link rel="stylesheet" href="/styles/app.css">
</head>
<body class="app-page app-waitlist">
  <div class="app-container">
    <header class="app-header">
      <a href="/" class="back-link">‚Üê Voltar</a>
      <div class="app-title">
        <span class="app-icon">üìã</span>
        <h1>Waitlist com Referral</h1>
      </div>
      <p class="app-subtitle">Crie sua lista de espera com sistema de indica√ß√µes gamificado</p>
    </header>

    <main class="app-main">
      <div class="input-section">
        <h2>Entrar na Waitlist</h2>
        <form id="subscribeForm">
          <div class="form-group">
            <label for="name">Nome Completo</label>
            <input type="text" id="name" required placeholder="Seu nome">
          </div>
          
          <div class="form-group">
            <label for="email">E-mail</label>
            <input type="email" id="email" required placeholder="seu@email.com">
          </div>

          <div class="form-group">
            <label for="referralCode">C√≥digo de Indica√ß√£o (opcional)</label>
            <input type="text" id="referralCode" placeholder="Digite o c√≥digo se foi indicado">
          </div>

          <button type="submit" class="btn-primary">
            <span class="btn-icon">üöÄ</span>
            Entrar na Lista
          </button>
        </form>

        <hr class="divider">

        <h2>Verificar Status</h2>
        <form id="statusForm">
          <div class="form-group">
            <label for="checkEmail">Seu e-mail</label>
            <input type="email" id="checkEmail" required placeholder="seu@email.com">
          </div>
          <button type="submit" class="btn-secondary full-width">
            Verificar Posi√ß√£o
          </button>
        </form>
      </div>

      <div class="output-section">
        <div id="resultSection" class="hidden">
          <div id="result"></div>
        </div>

        <div id="leaderboardSection">
          <h2>üèÜ Top Indicadores</h2>
          <button onclick="loadLeaderboard()" class="btn-secondary mb-20">
            Carregar Ranking
          </button>
          <div id="leaderboard"></div>
        </div>
      </div>
    </main>

    <div id="loading" class="loading hidden">
      <div class="spinner"></div>
      <p>Processando...</p>
    </div>
  </div>

  <script src="/scripts/app.js"></script>
  <script>
    document.getElementById('subscribeForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      showLoading();
      
      try {
        const data = await apiCall('waitlist', {
          action: 'subscribe',
          email: document.getElementById('email').value,
          name: document.getElementById('name').value,
          referralCode: document.getElementById('referralCode').value || null
        });
        
        hideLoading();
        
        if (data.ok) {
          document.getElementById('resultSection').classList.remove('hidden');
          document.getElementById('result').innerHTML = `
            <div class="alert alert-success">
              <h3>‚úÖ Bem-vindo √† lista!</h3>
              <p><strong>Posi√ß√£o:</strong> #${data.position} de ${data.totalWaiting}</p>
              <p><strong>Seu c√≥digo de referral:</strong> <code class="inline-code">${data.referralCode}</code></p>
              <p class="mt-12">Compartilhe seu c√≥digo e suba posi√ß√µes na fila! Cada indica√ß√£o te coloca 1 dia √† frente.</p>
            </div>
          `;
          document.getElementById('subscribeForm').reset();
        } else {
          showAlert(data.error || 'Erro ao cadastrar', 'error');
        }
      } catch (error) {
        hideLoading();
        showAlert('Erro de conex√£o', 'error');
      }
    });

    document.getElementById('statusForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      showLoading();
      
      try {
        const data = await apiCall('waitlist', {
          action: 'status',
          email: document.getElementById('checkEmail').value
        });
        
        hideLoading();
        
        if (data.ok) {
          document.getElementById('resultSection').classList.remove('hidden');
          document.getElementById('result').innerHTML = `
            <div class="stats-grid">
              <div class="stat-card">
                <span class="stat-value">#${data.position}</span>
                <span class="stat-label">Sua Posi√ß√£o</span>
              </div>
              <div class="stat-card">
                <span class="stat-value">${data.referrals || 0}</span>
                <span class="stat-label">Indica√ß√µes</span>
              </div>
              <div class="stat-card">
                <span class="stat-value">${data.totalWaiting}</span>
                <span class="stat-label">Total na Fila</span>
              </div>
            </div>
            <p><strong>Seu c√≥digo:</strong> <code class="inline-code">${data.subscriber.referralCode}</code></p>
          `;
        } else {
          showAlert('E-mail n√£o encontrado na lista', 'error');
        }
      } catch (error) {
        hideLoading();
        showAlert('Erro de conex√£o', 'error');
      }
    });

    async function loadLeaderboard() {
      showLoading();
      try {
        const data = await apiCall('waitlist', { action: 'leaderboard' });
        hideLoading();
        
        if (data.ok && data.leaderboard.length > 0) {
          document.getElementById('leaderboard').innerHTML = data.leaderboard.map((sub, i) => `
            <div class="list-item">
              <h4>${i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : `#${i + 1}`} ${sub.name}</h4>
              <p>${sub.referrals || 0} indica√ß√µes</p>
            </div>
          `).join('');
        } else {
          document.getElementById('leaderboard').innerHTML = '<div class="empty-state"><p>Nenhum dado ainda</p></div>';
        }
      } catch (error) {
        hideLoading();
        showAlert('Erro ao carregar ranking', 'error');
      }
    }
  </script>
</body>
</html>